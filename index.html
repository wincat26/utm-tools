<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTM Manager - é€£çµç”¢ç”Ÿå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="shared/styles.css">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="nav-container">
    <div class="text-xl font-bold">UTM Manager</div>
    <div class="nav-tabs">
      <a href="index.html" class="nav-tab">ğŸ”— ç”¢ç”Ÿå™¨</a>
      <a href="history.html" class="nav-tab">ğŸ“‹ æˆ‘çš„é€£çµ</a>
      <a href="templates.html" class="nav-tab">ğŸ“ å¸¸ç”¨ç¯„æœ¬</a>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="main-container">
    <div class="page-card">
      <h1 class="text-2xl font-bold mb-6 text-center">UTM é€£çµç”¢ç”Ÿå™¨</h1>
      
      <!-- å¿«é€Ÿç¯„æœ¬æŒ‰éˆ• -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-sm font-medium mb-3 text-gray-700">å¿«é€Ÿå¥—ç”¨å¸¸ç”¨ç¯„æœ¬</h3>
        <div class="flex flex-wrap gap-2">
          <button class="template-btn" data-template="google_ads">Google Ads</button>
          <button class="template-btn" data-template="facebook">Facebook</button>
          <button class="template-btn" data-template="instagram">Instagram</button>
          <button class="template-btn" data-template="edm">EDM</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- å·¦å´ï¼šåƒæ•¸è¨­å®š -->
        <div class="space-y-4">
          <h2 class="text-lg font-semibold">åƒæ•¸è¨­å®š</h2>
          
          <div>
            <label class="block text-sm font-medium mb-1">ç¶²ç«™ç¶²å€ <span class="text-red-500">*</span></label>
            <input type="url" id="websiteUrl" placeholder="https://example.com" class="form-input">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">utm_source</label>
              <input type="text" id="utmSource" placeholder="google" class="form-input">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">utm_medium</label>
              <input type="text" id="utmMedium" placeholder="cpc" class="form-input">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">utm_campaign <span class="text-red-500">*</span></label>
            <input type="text" id="utmCampaign" placeholder="summer_sale_2024" class="form-input">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">utm_term</label>
            <input type="text" id="utmTerm" placeholder="é—œéµå­—æˆ–æ—¥æœŸ" class="form-input">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">utm_content</label>
            <input type="text" id="utmContent" placeholder="å»£å‘Šç´ æåç¨±" class="form-input">
          </div>

          <!-- AI ç”Ÿæˆå€å¡Š -->
          <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-sm font-medium">ğŸ¤– AI æ™ºæ…§åŠ©æ‰‹</h3>
              <div class="flex gap-2 items-center">
                <div id="aiStatus" class="text-xs"></div>
                <a href="ai-setup.html" class="text-xs text-blue-500 hover:text-blue-700">ğŸ“š èªªæ˜</a>
                <button id="aiSettings" class="text-xs text-gray-500 hover:text-gray-700">âš™ï¸ è¨­å®š</button>
              </div>
            </div>
            <textarea id="aiPrompt" rows="2" placeholder="æè¿°ä½ çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šGoogle Ads å¤å­£ç‰¹è³£æ´»å‹•" class="form-input mb-2"></textarea>
            <div class="flex gap-2">
              <button id="aiGenerate" class="btn-primary flex-1">ç”Ÿæˆ UTM</button>
              <button id="aiAsk" class="btn-secondary flex-1">å•å•é¡Œ</button>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šçµæœé è¦½ -->
        <div class="space-y-4">
          <h2 class="text-lg font-semibold">ç”¢å‡ºçµæœ</h2>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <label class="block text-sm font-medium mb-2">ç”Ÿæˆé€£çµé è¦½</label>
            <div id="resultBox" class="bg-white p-3 rounded border text-sm break-all min-h-[4rem] flex items-center">
              é€£çµå°‡åœ¨æ­¤è™•é¡¯ç¤º...
            </div>
          </div>

          <div class="flex gap-3">
            <button id="copyButton" class="btn-primary flex-1">ğŸ“‹ è¤‡è£½é€£çµ</button>
            <button id="saveButton" class="btn-secondary flex-1">ğŸ’¾ å„²å­˜è¨˜éŒ„</button>
          </div>
          


          <!-- éŒ¯èª¤è¨ºæ–· -->
          <div id="diagnostics" class="hidden">
            <h3 class="text-sm font-medium mb-2 text-orange-600">âš ï¸ å»ºè­°ä¿®æ­£</h3>
            <div id="diagnosticsList" class="space-y-2"></div>
          </div>

          <div id="statusMessage" class="text-center text-sm"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="shared/utils.js"></script>
  <script src="shared/ai-helper.js"></script>
  <script src="shared/sync-api.js"></script>
  <script src="shared/url-shortener.js"></script>
  <script>
    // ç¯„æœ¬è³‡æ–™
    const templates = {
      google_ads: { source: 'google', medium: 'cpc' },
      facebook: { source: 'facebook', medium: 'paid_social' },
      instagram: { source: 'instagram', medium: 'paid_social' },
      edm: { source: 'newsletter', medium: 'email' }
    };

    // DOM å…ƒç´ 
    const elements = {
      websiteUrl: document.getElementById('websiteUrl'),
      utmSource: document.getElementById('utmSource'),
      utmMedium: document.getElementById('utmMedium'),
      utmCampaign: document.getElementById('utmCampaign'),
      utmTerm: document.getElementById('utmTerm'),
      utmContent: document.getElementById('utmContent'),
      resultBox: document.getElementById('resultBox'),
      copyButton: document.getElementById('copyButton'),
      saveButton: document.getElementById('saveButton'),
      aiPrompt: document.getElementById('aiPrompt'),
      aiButton: document.getElementById('aiButton')
    };

    // æ›´æ–°UTMé€£çµé è¦½
    function updatePreview() {
      const websiteUrl = elements.websiteUrl.value.trim();
      const utmCampaign = elements.utmCampaign.value.trim();
      
      if (!websiteUrl || !utmCampaign) {
        elements.resultBox.textContent = 'è«‹å¡«å¯«ç¶²ç«™ç¶²å€å’Œæ´»å‹•åç¨±';
        return;
      }

      const params = {
        utm_source: elements.utmSource.value.trim(),
        utm_medium: elements.utmMedium.value.trim(),
        utm_campaign: utmCampaign,
        utm_term: elements.utmTerm.value.trim(),
        utm_content: elements.utmContent.value.trim()
      };

      const finalUrl = buildUtmUrl(websiteUrl, params);
      elements.resultBox.textContent = finalUrl || 'ç¶²å€æ ¼å¼éŒ¯èª¤';
      
      // åŒæ™‚åŸ·è¡Œè¨ºæ–·
      runDiagnostics();
    }

    // å¥—ç”¨ç¯„æœ¬
    function applyTemplate(templateKey) {
      const template = templates[templateKey];
      if (template) {
        elements.utmSource.value = template.source;
        elements.utmMedium.value = template.medium;
        updatePreview();
        showStatus(`å·²å¥—ç”¨ ${templateKey} ç¯„æœ¬`, 'success');
      }
    }

    // è¤‡è£½é€£çµ
    async function copyLink() {
      const link = elements.resultBox.textContent;
      if (!link || link.includes('è«‹å¡«å¯«') || link.includes('éŒ¯èª¤')) {
        showStatus('æ²’æœ‰å¯è¤‡è£½çš„é€£çµ', 'error');
        return;
      }
      
      const success = await copyToClipboard(link);
      showStatus(success ? 'é€£çµå·²è¤‡è£½ï¼' : 'è¤‡è£½å¤±æ•—', success ? 'success' : 'error');
    }

    // å„²å­˜è¨˜éŒ„
    async function saveRecord() {
      const link = elements.resultBox.textContent;
      if (!link || link.includes('è«‹å¡«å¯«') || link.includes('éŒ¯èª¤')) {
        showStatus('è«‹å…ˆç”¢ç”Ÿæœ‰æ•ˆé€£çµ', 'error');
        return;
      }

      const record = {
        timestamp: new Date().toISOString(),
        websiteUrl: elements.websiteUrl.value.trim(),
        utmSource: elements.utmSource.value.trim(),
        utmMedium: elements.utmMedium.value.trim(),
        utmCampaign: elements.utmCampaign.value.trim(),
        utmTerm: elements.utmTerm.value.trim(),
        utmContent: elements.utmContent.value.trim(),
        finalUrl: link,
        shortUrl: '' // åœ¨æ­·å²è¨˜éŒ„ä¸­ç”¢ç”Ÿ
      };

      // å„²å­˜åˆ°æœ¬åœ°
      const records = Storage.get('utm_records') || [];
      records.unshift(record);
      Storage.set('utm_records', records.slice(0, 100)); // åªä¿ç•™æœ€è¿‘100ç­†

      showStatus('è¨˜éŒ„å·²å„²å­˜ï¼', 'success');

      // å¦‚æœæœ‰è¨­å®šåŒæ­¥ï¼Œå•æ˜¯å¦è¦åŒæ­¥åˆ° Google Sheet
      if (syncManager.checkConfig()) {
        const shouldSync = confirm('è¨˜éŒ„å·²å„²å­˜åˆ°æœ¬åœ°ã€‚\n\næ˜¯å¦è¦åŒæ­¥åˆ° Google Sheetï¼Ÿ');
        if (shouldSync) {
          try {
            showStatus('æ­£åœ¨åŒæ­¥åˆ° Google Sheet...', 'info');
            await syncManager.syncRecord(record);
            showStatus('âœ… è¨˜éŒ„å·²å„²å­˜ä¸¦åŒæ­¥åˆ° Google Sheetï¼', 'success');
          } catch (error) {
            showStatus(`âš ï¸ æœ¬åœ°å„²å­˜æˆåŠŸï¼Œä½†åŒæ­¥å¤±æ•—ï¼š${error.message}`, 'warning');
          }
        }
      }
    }

    // å¾ URL åƒæ•¸è¼‰å…¥ç¯„æœ¬
    function loadFromUrlParams() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('source')) {
        elements.utmSource.value = params.get('source');
      }
      if (params.get('medium')) {
        elements.utmMedium.value = params.get('medium');
      }
      if (params.get('campaign')) {
        elements.utmCampaign.value = params.get('campaign');
      }
      updatePreview();
    }

    // AI åŠŸèƒ½
    async function generateWithAI() {
      const prompt = elements.aiPrompt.value.trim();
      const websiteUrl = elements.websiteUrl.value.trim();
      
      if (!prompt) {
        showStatus('è«‹æè¿°ä½ çš„UTMéœ€æ±‚', 'error');
        return;
      }
      
      try {
        showStatus('æ­£åœ¨ç”ŸæˆUTMåƒæ•¸...', 'info');
        const utmData = await aiHelper.generateUTM(prompt, websiteUrl);
        
        // å¡«å…¥ç”Ÿæˆçš„åƒæ•¸
        if (utmData.utm_source) elements.utmSource.value = utmData.utm_source;
        if (utmData.utm_medium) elements.utmMedium.value = utmData.utm_medium;
        if (utmData.utm_campaign) elements.utmCampaign.value = utmData.utm_campaign;
        if (utmData.utm_term) elements.utmTerm.value = utmData.utm_term;
        if (utmData.utm_content) elements.utmContent.value = utmData.utm_content;
        
        updatePreview();
        showStatus('AIå·²æˆåŠŸç”ŸæˆUTMåƒæ•¸ï¼', 'success');
      } catch (error) {
        showStatus(error.message, 'error');
        if (error.message.includes('API Key')) {
          showAISettings();
        }
      }
    }
    
    async function askAI() {
      const question = elements.aiPrompt.value.trim();
      
      if (!question) {
        showStatus('è«‹è¼¸å…¥ä½ çš„å•é¡Œ', 'error');
        return;
      }
      
      try {
        showStatus('æ­£åœ¨è«‹æ•™AI...', 'info');
        
        const context = {
          websiteUrl: elements.websiteUrl.value.trim(),
          utmParams: {
            utm_source: elements.utmSource.value.trim(),
            utm_medium: elements.utmMedium.value.trim(),
            utm_campaign: elements.utmCampaign.value.trim(),
            utm_term: elements.utmTerm.value.trim(),
            utm_content: elements.utmContent.value.trim()
          }
        };
        
        const answer = await aiHelper.askQuestion(question, context);
        
        // é¡¯ç¤ºAIå›ç­”
        alert(`AIå›ç­”ï¼š\n\n${answer}`);
        showStatus('AIå·²å›ç­”ä½ çš„å•é¡Œ', 'success');
      } catch (error) {
        showStatus(error.message, 'error');
        if (error.message.includes('API Key')) {
          showAISettings();
        }
      }
    }
    
    function showAISettings() {
      const hasKey = aiHelper.checkApiKey();
      
      if (hasKey) {
        const action = confirm('ç›®å‰å·²è¨­å®š Gemini API Key\n\né»æ“Šã€Œç¢ºå®šã€æ›´æ› API Key\né»æ“Šã€Œå–æ¶ˆã€ç§»é™¤ API Key');
        
        if (action) {
          // æ›´æ› API Key
          const newKey = prompt('è«‹è¼¸å…¥æ–°çš„ Gemini API Keyï¼š', '');
          if (newKey && newKey.trim()) {
            aiHelper.setApiKey(newKey.trim());
            updateAIStatus();
            showStatus('API Key å·²æ›´æ–°ï¼', 'success');
          }
        } else {
          // ç§»é™¤ API Key
          if (confirm('ç¢ºå®šè¦ç§»é™¤ API Key å—ï¼Ÿ')) {
            aiHelper.setApiKey('');
            updateAIStatus();
            showStatus('API Key å·²ç§»é™¤', 'info');
          }
        }
      } else {
        // æ–°å¢ API Key
        const newKey = prompt('è«‹è¼¸å…¥ä½ çš„ Gemini API Keyï¼š\n\nå¦‚ä½•å–å¾—ï¼š\n1. å‰å¾€ https://aistudio.google.com/app/apikey\n2. é»æ“Š "Create API Key"\n3. è¤‡è£½ä¸¦è²¼ä¸Šä½ çš„ API Key');
        
        if (newKey && newKey.trim()) {
          aiHelper.setApiKey(newKey.trim());
          updateAIStatus();
          showStatus('API Key å·²è¨­å®šï¼', 'success');
        }
      }
    }
    
    function updateAIStatus() {
      const statusEl = document.getElementById('aiStatus');
      const hasKey = aiHelper.checkApiKey();
      
      if (hasKey) {
        statusEl.innerHTML = '<span class="text-green-600">âœ“ å·²è¨­å®š</span>';
      } else {
        statusEl.innerHTML = '<span class="text-gray-400">æœªè¨­å®š</span>';
      }
    }
    


    function runDiagnostics() {
      const websiteUrl = elements.websiteUrl.value.trim();
      const utmParams = {
        utm_source: elements.utmSource.value.trim(),
        utm_medium: elements.utmMedium.value.trim(),
        utm_campaign: elements.utmCampaign.value.trim(),
        utm_term: elements.utmTerm.value.trim(),
        utm_content: elements.utmContent.value.trim()
      };
      
      const issues = aiHelper.diagnoseError(websiteUrl, utmParams);
      const diagnosticsEl = document.getElementById('diagnostics');
      const diagnosticsListEl = document.getElementById('diagnosticsList');
      
      if (issues.length === 0) {
        diagnosticsEl.classList.add('hidden');
        return;
      }
      
      diagnosticsEl.classList.remove('hidden');
      diagnosticsListEl.innerHTML = issues.map(issue => {
        const iconMap = { error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
        const colorMap = { error: 'text-red-600', warning: 'text-orange-600', info: 'text-blue-600' };
        
        return `
          <div class="text-xs ${colorMap[issue.type]} bg-gray-50 p-2 rounded">
            <div class="font-medium">${iconMap[issue.type]} ${issue.message}</div>
            <div class="text-gray-600 mt-1">å»ºè­°ï¼š${issue.solution}</div>
          </div>
        `;
      }).join('');
    }

    // äº‹ä»¶ç¶å®š
    document.addEventListener('DOMContentLoaded', () => {
      // è¼‰å…¥ URL åƒæ•¸
      loadFromUrlParams();
      
      // è¼¸å…¥äº‹ä»¶
      Object.values(elements).forEach(el => {
        if (el && el.addEventListener) {
          el.addEventListener('input', updatePreview);
        }
      });

      // ç¯„æœ¬æŒ‰éˆ•
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          applyTemplate(btn.dataset.template);
        });
      });

      // åŠŸèƒ½æŒ‰éˆ•
      elements.copyButton.addEventListener('click', copyLink);
      elements.saveButton.addEventListener('click', saveRecord);

      // AI åŠŸèƒ½
      document.getElementById('aiGenerate').addEventListener('click', generateWithAI);
      document.getElementById('aiAsk').addEventListener('click', askAI);
      document.getElementById('aiSettings').addEventListener('click', showAISettings);
      


      // åˆå§‹é è¦½å’Œè¨ºæ–·
      updatePreview();
      runDiagnostics();
      updateAIStatus();
    });
  </script>

  <style>
    .template-btn {
      @apply px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors cursor-pointer;
    }
    
    .status-message {
      transition: all 0.3s;
    }
    
    .status-success { @apply text-green-600; }
    .status-error { @apply text-red-600; }
    .status-info { @apply text-blue-600; }
    .status-warning { @apply text-orange-600; }
  </style>
</body>
</html>