<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTM Manager - 連結產生器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="shared/styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <!-- 導航列 -->
  <nav class="bg-white shadow-sm border-b border-gray-100 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-link text-white text-sm"></i>
        </div>
        <h1 class="text-xl font-semibold text-gray-900">UTM Manager</h1>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="nav-tab-modern nav-tab-active">
          <i class="fas fa-magic"></i>
          <span>產生器</span>
        </a>
        <a href="history.html" class="nav-tab-modern">
          <i class="fas fa-history"></i>
          <span>我的連結</span>
        </a>
        <a href="templates.html" class="nav-tab-modern">
          <i class="fas fa-bookmark"></i>
          <span>常用範本</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- 主要內容 -->
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-magic text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">UTM 連結產生器</h1>
          <p class="text-gray-600">快速產生專業的 UTM 追蹤連結</p>
        </div>
      
        <!-- 快速範本按鈕 -->
        <div class="mb-10 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-6 h-6 bg-blue-500 rounded-lg flex items-center justify-center">
              <i class="fas fa-bolt text-white text-xs"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">快速套用範本</h3>
          </div>
          <div id="quickTemplates" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3">
            <!-- 範本按鈕將動態生成 -->
          </div>
        </div>

        <!-- 步驟式介面 -->
        <div class="space-y-8">
          <!-- 步驟 1: 參數設定 -->
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100 p-8 mb-10">
            <div class="flex items-center gap-3 mb-8">
              <div class="step-indicator step-indicator-1">1</div>
              <h2 class="text-xl font-semibold text-gray-900">設定 UTM 參數</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8 gap-6" style="grid-template-columns: 2fr 2fr 1fr;">
          
              <!-- 左側：基本參數 -->
              <div class="space-y-5">
                <div class="form-group">
                  <label class="form-label form-label-required">
                    <i class="fas fa-globe text-blue-500"></i>
                    網站網址
                  </label>
                  <input type="url" id="websiteUrl" placeholder="https://example.com" class="form-input">
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-tag text-green-500"></i>
                      utm_source
                    </label>
                    <input type="text" id="utmSource" placeholder="google" class="form-input">
                  </div>
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-bullhorn text-orange-500"></i>
                      utm_medium
                    </label>
                    <input type="text" id="utmMedium" placeholder="cpc" class="form-input">
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label form-label-required">
                    <i class="fas fa-rocket text-purple-500"></i>
                    utm_campaign
                  </label>
                  <input type="text" id="utmCampaign" placeholder="summer_sale_2024" class="form-input">
                </div>
              </div>
              
              <!-- 右側：進階參數 -->
              <div class="space-y-5">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-search text-yellow-500"></i>
                    utm_term <span class="form-label-optional">(可選)</span>
                  </label>
                  <input type="text" id="utmTerm" placeholder="關鍵字或日期" class="form-input">
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-image text-pink-500"></i>
                    utm_content <span class="form-label-optional">(可選)</span>
                  </label>
                  <input type="text" id="utmContent" placeholder="廣告素材名稱" class="form-input">
                </div>
                
                <!-- 動作按鈕 -->
                <div class="flex flex-col gap-3 pt-6">
                  <button id="generateButton" class="btn-base btn-primary btn-lg w-full">
                    <i class="fas fa-magic"></i>
                    產生連結
                  </button>
                  <button id="clearButton" class="btn-base btn-secondary w-full">
                    <i class="fas fa-eraser"></i>
                    清除
                  </button>
                </div>
              </div>
            </div>
            
            <!-- 診斷訊息 -->
            <div id="diagnostics" class="hidden mt-8 alert alert-error fade-in">
              <div class="flex items-center gap-3 mb-4">
                <div class="diagnostic-icon">
                  <i class="fas fa-exclamation"></i>
                </div>
                <h3 class="text-sm font-semibold">建議修正</h3>
              </div>
              <div id="diagnosticsList" class="space-y-3"></div>
            </div>
          </div>

          <!-- 步驟 2: 結果預覽 -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-100 p-8 mb-10">
            <div class="flex items-center gap-3 mb-8">
              <div class="step-indicator step-indicator-2">2</div>
              <h2 class="text-xl font-semibold text-gray-900">預覽和管理</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" style="grid-template-columns: 2fr 1fr;">
              <!-- 連結預覽 -->
              <div class="space-y-4">
                <label class="form-label">
                  <i class="fas fa-link text-green-500"></i>
                  生成連結預覽
                </label>
                <div id="resultBox" class="result-preview">
                  連結將在此處顯示...
                </div>
                
                <div class="flex gap-3">
                  <button id="copyButton" class="btn-base btn-primary flex-1" style="background: linear-gradient(135deg, var(--success-green), #059669);">
                    <i class="fas fa-copy"></i>
                    複製連結
                  </button>
                  <button id="saveButton" class="btn-base btn-secondary flex-1" style="border-color: var(--success-green-200); color: var(--success-green);">
                    <i class="fas fa-save"></i>
                    儲存記錄
                  </button>
                </div>
              </div>
              
              <!-- 狀態和設定 -->
              <div class="space-y-4">
                <!-- 功能狀態 -->
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">功能狀態</h3>
                  </div>
                  <div class="space-y-3">
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">AI 助手:</span>
                      <div id="aiStatus"></div>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm text-gray-600">雲端同步:</span>
                      <div id="cloudStatus"></div>
                    </div>
                  </div>
                </div>
                
                <!-- 快速設定 -->
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">快速設定</h3>
                  </div>
                  <div class="flex flex-col gap-2">
                    <button id="cloudSync" class="btn-base btn-tertiary btn-sm justify-start">
                      <i class="fas fa-cloud-upload-alt"></i>
                      雲端同步
                    </button>
                    <button id="aiSettings" class="btn-base btn-tertiary btn-sm justify-start" style="color: #8b5cf6;">
                      <i class="fas fa-key"></i>
                      AI 設定
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 步驟 3: AI 智慧助手 -->
          <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-100 p-8">
            <div class="flex items-center gap-3 mb-8">
              <div class="step-indicator step-indicator-3">3</div>
              <h2 class="text-xl font-semibold text-gray-900">AI 智慧助手</h2>
            </div>
            
            <!-- AI 對話區域 -->
            <div id="aiChatArea" class="card mb-4 max-h-96 overflow-y-auto hidden">
              <div id="aiMessages" class="space-y-3">
                <!-- AI 對話訊息將在這裡顯示 -->
              </div>
            </div>
            
            <!-- 輸入區域 -->
            <div class="flex gap-3 mb-3">
              <div class="flex-1 relative">
                <input type="text" id="aiPrompt" placeholder="描述你的需求，例如：Google Ads 夏季特賣活動" class="form-input pr-12" style="border-color: #8b5cf6;">
                <button id="aiSend" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 text-purple-500 hover:text-purple-700 transition-colors">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            
            <!-- 快速動作 -->
            <div class="flex gap-2">
              <button id="aiGenerate" class="btn-base btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <i class="fas fa-magic"></i>
                生成 UTM
              </button>
              <button id="aiAsk" class="btn-base btn-secondary btn-sm">
                <i class="fas fa-question-circle"></i>
                問問題
              </button>
              <button id="aiClear" class="btn-base btn-tertiary btn-sm">
                <i class="fas fa-eraser"></i>
                清除
              </button>
            </div>
          </div>
        </div>

        <div id="statusMessage" class="text-center text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
  <!-- 安全配置 -->
  <script src="shared/secure-config.js"></script>
  
  <script src="shared/utils.js"></script>
  <script src="shared/ai-helper.js"></script>
  <script src="shared/ai-chat.js"></script>
  <script src="shared/sync-api.js"></script>
  <script src="shared/url-shortener.js"></script>
  <script src="shared/firebase-storage.js"></script>
  <script>
    // 系統預設範本
    const systemTemplates = [
      { name: 'Google Ads', source: 'google', medium: 'cpc' },
      { name: 'Facebook Ads', source: 'facebook', medium: 'paid_social' },
      { name: 'Instagram Ads', source: 'instagram', medium: 'paid_social' },
      { name: 'EDM Newsletter', source: 'newsletter', medium: 'email' },
      { name: 'TikTok Ads', source: 'tiktok', medium: 'paid_social' },
      { name: 'LINE 官方帳號', source: 'line_oa', medium: 'im' }
    ];

    // DOM 元素
    const elements = {
      websiteUrl: document.getElementById('websiteUrl'),
      utmSource: document.getElementById('utmSource'),
      utmMedium: document.getElementById('utmMedium'),
      utmCampaign: document.getElementById('utmCampaign'),
      utmTerm: document.getElementById('utmTerm'),
      utmContent: document.getElementById('utmContent'),
      resultBox: document.getElementById('resultBox'),
      copyButton: document.getElementById('copyButton'),
      saveButton: document.getElementById('saveButton'),
      aiPrompt: document.getElementById('aiPrompt'),
      aiButton: document.getElementById('aiButton')
    };

    // 更新UTM連結預覽
    function updatePreview() {
      const websiteUrl = elements.websiteUrl.value.trim();
      const utmCampaign = elements.utmCampaign.value.trim();
      
      if (!websiteUrl || !utmCampaign) {
        elements.resultBox.textContent = '請填寫網站網址和活動名稱';
        elements.resultBox.classList.remove('has-content');
        return;
      }

      const params = {
        utm_source: elements.utmSource.value.trim(),
        utm_medium: elements.utmMedium.value.trim(),
        utm_campaign: utmCampaign,
        utm_term: elements.utmTerm.value.trim(),
        utm_content: elements.utmContent.value.trim()
      };

      const finalUrl = buildUtmUrl(websiteUrl, params);
      elements.resultBox.textContent = finalUrl || '網址格式錯誤';
      
      if (finalUrl && !finalUrl.includes('錯誤')) {
        elements.resultBox.classList.add('has-content');
      } else {
        elements.resultBox.classList.remove('has-content');
      }
      
      // 同時執行診斷
      runDiagnostics();
    }

    // 套用範本
    function applyTemplate(source, medium, campaign = '', templateName = '') {
      elements.utmSource.value = source;
      elements.utmMedium.value = medium;
      if (campaign) {
        elements.utmCampaign.value = campaign;
      }
      updatePreview();
      
      // 記錄使用歷史
      recordTemplateUsage(source, medium, campaign, templateName);
      
      showStatus(`已套用 ${templateName || '範本'}`, 'success');
    }
    
    // 記錄範本使用歷史
    function recordTemplateUsage(source, medium, campaign, name) {
      const usage = {
        source,
        medium,
        campaign: campaign || '',
        name: name || `${source}/${medium}`,
        lastUsed: Date.now()
      };
      
      let recentTemplates = Storage.get('recent_templates') || [];
      
      // 移除重複的範本
      recentTemplates = recentTemplates.filter(t => 
        !(t.source === source && t.medium === medium && t.campaign === campaign)
      );
      
      // 加入到最前面
      recentTemplates.unshift(usage);
      
      // 只保留最近10個
      recentTemplates = recentTemplates.slice(0, 10);
      
      Storage.set('recent_templates', recentTemplates);
      
      // 更新快速範本顯示
      renderQuickTemplates();
    }
    
    // 渲染快速範本按鈕
    function renderQuickTemplates() {
      const container = document.getElementById('quickTemplates');
      const recentTemplates = Storage.get('recent_templates') || [];
      const userTemplates = Storage.get('user_templates') || [];
      
      let templates = [];
      
      // 1. 最近使用的範本（最多5個）
      templates = templates.concat(recentTemplates.slice(0, 5).map(t => ({
        ...t,
        type: 'recent',
        displayName: t.name
      })));
      
      // 2. 個人範本（排除已在最近使用中的）
      const recentKeys = recentTemplates.map(t => `${t.source}-${t.medium}-${t.campaign}`);
      const unusedUserTemplates = userTemplates.filter(t => 
        !recentKeys.includes(`${t.source}-${t.medium}-${t.campaign || ''}`)
      ).slice(0, 3); // 最多3個
      
      templates = templates.concat(unusedUserTemplates.map(t => ({
        ...t,
        type: 'user',
        displayName: t.name
      })));
      
      // 3. 系統預設範本（填滿剩餘空間，最多8個總數）
      const totalUsed = templates.length;
      const remainingSlots = Math.max(0, 8 - totalUsed);
      const usedSystemKeys = templates.map(t => `${t.source}-${t.medium}`);
      const unusedSystemTemplates = systemTemplates.filter(t => 
        !usedSystemKeys.includes(`${t.source}-${t.medium}`)
      ).slice(0, remainingSlots);
      
      templates = templates.concat(unusedSystemTemplates.map(t => ({
        ...t,
        type: 'system',
        displayName: t.name
      })));
      
      // 渲染按鈕
      container.innerHTML = templates.map(template => {
        const typeClass = {
          recent: 'template-button-recent',
          user: 'template-button-user',
          system: 'template-button-system'
        }[template.type];
        
        const typeIcon = {
          recent: '<i class="fas fa-clock"></i>',
          user: '<i class="fas fa-star"></i>',
          system: '<i class="fas fa-bookmark"></i>'
        }[template.type];
        
        return `
          <button class="template-button ${typeClass}" 
                  onclick="applyTemplate('${template.source}', '${template.medium}', '${template.campaign || ''}', '${template.displayName}')">
            ${typeIcon}
            <span>${template.displayName}</span>
          </button>
        `;
      }).join('');
    }

    // 複製連結
    async function copyLink() {
      const link = elements.resultBox.textContent;
      if (!link || link.includes('請填寫') || link.includes('錯誤')) {
        showStatus('沒有可複製的連結', 'error');
        return;
      }
      
      const success = await copyToClipboard(link);
      showStatus(success ? '連結已複製！' : '複製失敗', success ? 'success' : 'error');
    }

    // 儲存記錄
    async function saveRecord() {
      const link = elements.resultBox.textContent;
      if (!link || link.includes('請填寫') || link.includes('錯誤')) {
        showStatus('請先產生有效連結', 'error');
        return;
      }

      const record = {
        timestamp: new Date().toISOString(),
        websiteUrl: elements.websiteUrl.value.trim(),
        utmSource: elements.utmSource.value.trim(),
        utmMedium: elements.utmMedium.value.trim(),
        utmCampaign: elements.utmCampaign.value.trim(),
        utmTerm: elements.utmTerm.value.trim(),
        utmContent: elements.utmContent.value.trim(),
        finalUrl: link,
        shortUrl: '' // 在歷史記錄中產生
      };

      // 儲存到本地
      const records = Storage.get('utm_records') || [];
      records.unshift(record);
      Storage.set('utm_records', records.slice(0, 100)); // 只保留最近100筆

      showStatus('記錄已儲存！', 'success');

      // 如果有設定同步，問是否要同步到 Google Sheet
      if (syncManager.checkConfig()) {
        const shouldSync = confirm('記錄已儲存到本地。\n\n是否要同步到 Google Sheet？');
        if (shouldSync) {
          try {
            showStatus('正在同步到 Google Sheet...', 'info');
            await syncManager.syncRecord(record);
            showStatus('✅ 記錄已儲存並同步到 Google Sheet！', 'success');
          } catch (error) {
            showStatus(`⚠️ 本地儲存成功，但同步失敗：${error.message}`, 'warning');
          }
        }
      }
    }

    // 從 URL 參數載入範本
    function loadFromUrlParams() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('source')) {
        elements.utmSource.value = params.get('source');
      }
      if (params.get('medium')) {
        elements.utmMedium.value = params.get('medium');
      }
      if (params.get('campaign')) {
        elements.utmCampaign.value = params.get('campaign');
      }
      updatePreview();
    }

    // AI 功能
    async function generateWithAI() {
      const prompt = elements.aiPrompt.value.trim();
      const websiteUrl = elements.websiteUrl.value.trim();
      
      if (!prompt) {
        showStatus('請描述你的UTM需求', 'error');
        return;
      }
      
      try {
        showStatus('正在生成UTM參數...', 'info');
        const utmData = await aiHelper.generateUTM(prompt, websiteUrl);
        
        // 填入生成的參數
        if (utmData.utm_source) elements.utmSource.value = utmData.utm_source;
        if (utmData.utm_medium) elements.utmMedium.value = utmData.utm_medium;
        if (utmData.utm_campaign) elements.utmCampaign.value = utmData.utm_campaign;
        if (utmData.utm_term) elements.utmTerm.value = utmData.utm_term;
        if (utmData.utm_content) elements.utmContent.value = utmData.utm_content;
        
        updatePreview();
        showStatus('AI已成功生成UTM參數！', 'success');
      } catch (error) {
        showStatus(error.message, 'error');
        if (error.message.includes('API Key')) {
          showAISettings();
        }
      }
    }
    
    async function askAI() {
      const question = elements.aiPrompt.value.trim();
      
      if (!question) {
        showStatus('請輸入你的問題', 'error');
        return;
      }
      
      try {
        showStatus('正在請教AI...', 'info');
        
        const context = {
          websiteUrl: elements.websiteUrl.value.trim(),
          utmParams: {
            utm_source: elements.utmSource.value.trim(),
            utm_medium: elements.utmMedium.value.trim(),
            utm_campaign: elements.utmCampaign.value.trim(),
            utm_term: elements.utmTerm.value.trim(),
            utm_content: elements.utmContent.value.trim()
          }
        };
        
        const answer = await aiHelper.askQuestion(question, context);
        
        // 顯示AI回答
        alert(`AI回答：\n\n${answer}`);
        showStatus('AI已回答你的問題', 'success');
      } catch (error) {
        showStatus(error.message, 'error');
        if (error.message.includes('API Key')) {
          showAISettings();
        }
      }
    }
    
    function showAISettings() {
      const hasKey = aiHelper.checkApiKey();
      
      if (hasKey) {
        const action = confirm('目前已設定 Gemini API Key\n\n點擊「確定」更換 API Key\n點擊「取消」移除 API Key');
        
        if (action) {
          // 更換 API Key
          const newKey = prompt('請輸入新的 Gemini API Key：', '');
          if (newKey && newKey.trim()) {
            aiHelper.setApiKey(newKey.trim());
            updateAIStatus();
            showStatus('API Key 已更新！', 'success');
          }
        } else {
          // 移除 API Key
          if (confirm('確定要移除 API Key 嗎？')) {
            aiHelper.setApiKey('');
            updateAIStatus();
            showStatus('API Key 已移除', 'info');
          }
        }
      } else {
        // 新增 API Key
        const newKey = prompt('請輸入你的 Gemini API Key：\n\n如何取得：\n1. 前往 https://aistudio.google.com/app/apikey\n2. 點擊 "Create API Key"\n3. 複製並貼上你的 API Key');
        
        if (newKey && newKey.trim()) {
          aiHelper.setApiKey(newKey.trim());
          updateAIStatus();
          showStatus('API Key 已設定！', 'success');
        }
      }
    }
    
    function updateAIStatus() {
      const statusEl = document.getElementById('aiStatus');
      const hasKey = aiHelper.checkApiKey();
      
      if (hasKey) {
        statusEl.innerHTML = '<span class="status-indicator status-success"><i class="fas fa-check-circle"></i> 已設定</span>';
      } else {
        statusEl.innerHTML = '<span class="status-indicator status-error"><i class="fas fa-times-circle"></i> 未設定</span>';
      }
    }
    
    function updateCloudStatus() {
      const statusEl = document.getElementById('cloudStatus');
      const hasConfig = firebaseStorage.getFirebaseConfig();
      
      if (hasConfig) {
        statusEl.innerHTML = '<span class="status-indicator status-success"><i class="fas fa-check-circle"></i> 已設定</span>';
      } else {
        statusEl.innerHTML = '<span class="status-indicator status-error"><i class="fas fa-times-circle"></i> 未設定</span>';
      }
    }
    
    async function performCloudSync() {
      try {
        showStatus('正在初始化 Firebase...', 'info');
        
        const initialized = await firebaseStorage.initialize();
        if (!initialized) {
          showStatus('請先設定 Firebase 配置', 'error');
          return;
        }
        
        const loggedIn = await firebaseStorage.signInAnonymously();
        if (!loggedIn) {
          showStatus('Firebase 登入失敗', 'error');
          return;
        }
        
        showStatus('正在同步資料...', 'info');
        
        const result = await firebaseStorage.fullSync();
        
        showStatus(`✅ 雲端同步完成！本地: ${result.localCount}, 雲端: ${result.cloudCount}, 總計: ${result.totalCount}`, 'success');
        
        updateCloudStatus();
        updateAIStatus();
        renderQuickTemplates();
        
      } catch (error) {
        showStatus(`雲端同步失敗: ${error.message}`, 'error');
      }
    }
    


    function runDiagnostics() {
      const websiteUrl = elements.websiteUrl.value.trim();
      const utmCampaign = elements.utmCampaign.value.trim();
      
      // 只有當使用者點擊「產生連結」但有錯誤時才顯示診斷
      if (!websiteUrl || !utmCampaign) {
        return; // 不顯示診斷訊息
      }
      
      const utmParams = {
        utm_source: elements.utmSource.value.trim(),
        utm_medium: elements.utmMedium.value.trim(),
        utm_campaign: utmCampaign,
        utm_term: elements.utmTerm.value.trim(),
        utm_content: elements.utmContent.value.trim()
      };
      
      const issues = aiHelper.diagnoseError(websiteUrl, utmParams);
      const diagnosticsEl = document.getElementById('diagnostics');
      const diagnosticsListEl = document.getElementById('diagnosticsList');
      
      if (issues.length === 0) {
        diagnosticsEl.classList.add('hidden');
        return;
      }
      
      diagnosticsEl.classList.remove('hidden');
      diagnosticsListEl.innerHTML = issues.map(issue => {
        const iconMap = { error: '❌', warning: '⚠️', info: 'ℹ️' };
        const colorMap = { error: 'text-red-700', warning: 'text-orange-700', info: 'text-blue-700' };
        
        return `
          <div class="text-sm ${colorMap[issue.type]} bg-white p-3 rounded-lg border border-orange-200">
            <div class="font-medium flex items-center gap-2">
              <span>${iconMap[issue.type]}</span>
              <span>${issue.message}</span>
            </div>
            <div class="text-orange-600 mt-1 ml-6">建議：${issue.solution}</div>
          </div>
        `;
      }).join('');
    }
    
    // 產生連結函數
    function generateLink() {
      const websiteUrl = elements.websiteUrl.value.trim();
      const utmCampaign = elements.utmCampaign.value.trim();
      
      // 檢查必填欄位
      const missingFields = [];
      
      if (!websiteUrl) {
        missingFields.push('網站網址');
        elements.websiteUrl.classList.add('form-input-error');
        elements.websiteUrl.classList.remove('form-input');
      } else {
        elements.websiteUrl.classList.remove('form-input-error');
        elements.websiteUrl.classList.add('form-input');
      }
      
      if (!utmCampaign) {
        missingFields.push('utm_campaign');
        elements.utmCampaign.classList.add('form-input-error');
        elements.utmCampaign.classList.remove('form-input');
      } else {
        elements.utmCampaign.classList.remove('form-input-error');
        elements.utmCampaign.classList.add('form-input');
      }
      
      if (missingFields.length > 0) {
        const fieldText = missingFields.join('、');
        showStatus(`請填寫必要欄位：${fieldText}`, 'error');
        
        // 顯示詳細診斷訊息
        showDetailedDiagnostics(missingFields);
        return;
      }
      
      // 清除錯誤樣式
      elements.websiteUrl.classList.remove('border-red-300', 'bg-red-50');
      elements.utmCampaign.classList.remove('border-red-300', 'bg-red-50');
      
      updatePreview();
      
      const link = elements.resultBox.textContent;
      if (link && !link.includes('請填寫') && !link.includes('錯誤')) {
        // 隱藏診斷訊息
        document.getElementById('diagnostics').classList.add('hidden');
        showStatus('✨ UTM 連結已產生！', 'success');
      }
    }
    
    // 顯示詳細診斷訊息
    function showDetailedDiagnostics(missingFields) {
      const diagnosticsEl = document.getElementById('diagnostics');
      const diagnosticsListEl = document.getElementById('diagnosticsList');
      
      const diagnostics = missingFields.map(field => {
        const fieldInfo = {
          '網站網址': {
            message: '網站網址為必填欄位',
            solution: '請輸入完整的網站網址，例如：https://example.com'
          },
          'utm_campaign': {
            message: '活動名稱 (utm_campaign) 為必填欄位',
            solution: '請輸入活動名稱，例如：summer_sale_2024'
          }
        };
        
        return fieldInfo[field] || {
          message: `${field} 為必填欄位`,
          solution: `請填寫 ${field} 欄位`
        };
      });
      
      diagnosticsListEl.innerHTML = diagnostics.map(diagnostic => `
        <div class="diagnostic-item">
          <div class="diagnostic-header">
            <div class="diagnostic-icon">
              <i class="fas fa-times"></i>
            </div>
            <span>${diagnostic.message}</span>
          </div>
          <div class="diagnostic-solution">建議：${diagnostic.solution}</div>
        </div>
      `).join('');
      
      diagnosticsEl.classList.remove('hidden');
    }
    
    // 清除表單
    function clearForm() {
      elements.websiteUrl.value = '';
      elements.utmSource.value = '';
      elements.utmMedium.value = '';
      elements.utmCampaign.value = '';
      elements.utmTerm.value = '';
      elements.utmContent.value = '';
      elements.resultBox.textContent = '連結將在此處顯示...';
      
      // 清除錯誤樣式
      elements.websiteUrl.classList.remove('border-red-300', 'bg-red-50');
      elements.utmCampaign.classList.remove('border-red-300', 'bg-red-50');
      elements.websiteUrl.classList.add('border-gray-200');
      elements.utmCampaign.classList.add('border-gray-200');
      
      // 隱藏診斷訊息
      document.getElementById('diagnostics').classList.add('hidden');
      
      showStatus('表單已清除', 'info');
    }

    // 初始化安全設定
    async function initializeSecureSettings() {
      // 嘗試載入 GitHub Secrets 配置
      if (window.SECURE_CONFIG) {
        if (window.SECURE_CONFIG.GEMINI_API_KEY && !Storage.get('gemini_api_key')) {
          Storage.set('gemini_api_key', window.SECURE_CONFIG.GEMINI_API_KEY);
        }
        if (window.SECURE_CONFIG.GOOGLE_APPS_SCRIPT_URL && !Storage.get('sync_api_url')) {
          Storage.set('sync_api_url', window.SECURE_CONFIG.GOOGLE_APPS_SCRIPT_URL);
        }
        console.log('✅ 已載入安全配置');
      } else {
        // Fallback: 如果沒有安全配置，使用預設值（臨時）
        if (!Storage.get('gemini_api_key')) {
          Storage.set('gemini_api_key', 'AIzaSyBVep_ohPIfsljmqljiNrL8EN03J3PMSMw');
        }
        if (!Storage.get('sync_api_url')) {
          Storage.set('sync_api_url', 'https://script.google.com/macros/s/AKfycbxmXzmwyGQhnnR2k3XsYIfSYV-601e8keq9qftoG8mi9hZnEIIOpqMPYY1RO5x6B33p-g/exec');
        }
        console.log('⚠️ 使用 Fallback 配置，建議設定 GitHub Secrets');
      }
    }

    // 事件綁定
    document.addEventListener('DOMContentLoaded', async () => {
      // 初始化安全設定
      await initializeSecureSettings();
      
      // 載入 URL 參數
      loadFromUrlParams();
      
      // 輸入事件
      Object.values(elements).forEach(el => {
        if (el && el.addEventListener) {
          el.addEventListener('input', updatePreview);
        }
      });

      // 初始化快速範本
      renderQuickTemplates();

      // 功能按鈕
      document.getElementById('generateButton').addEventListener('click', generateLink);
      document.getElementById('clearButton').addEventListener('click', clearForm);
      elements.copyButton.addEventListener('click', copyLink);
      elements.saveButton.addEventListener('click', saveRecord);

      // AI 功能
      document.getElementById('aiSend').addEventListener('click', sendAIMessage);
      document.getElementById('aiPrompt').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendAIMessage();
        }
      });
      document.getElementById('aiGenerate').addEventListener('click', generateWithAI);
      document.getElementById('aiAsk').addEventListener('click', askAI);
      document.getElementById('aiClear').addEventListener('click', clearAIChat);
      document.getElementById('aiSettings').addEventListener('click', showAISettings);
      


      // 初始預覽和診斷
      updatePreview();
      runDiagnostics();
      updateAIStatus();
      updateCloudStatus();
      renderQuickTemplates();
      
      // 雲端同步按鈕
      document.getElementById('cloudSync').addEventListener('click', performCloudSync);
    });
  </script>

  <style>
    /* 狀態訊息樣式 */
    .status-message {
      transition: all 0.3s ease;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: 500;
      text-align: center;
    }
    
    .status-success { 
      background: var(--success-green-100);
      color: var(--success-green);
      border: 1px solid var(--success-green-200);
    }
    
    .status-error { 
      background: var(--error-red-100);
      color: var(--error-red);
      border: 1px solid var(--error-red-200);
    }
    
    .status-info { 
      background: var(--primary-blue-100);
      color: var(--primary-blue);
      border: 1px solid var(--primary-blue-200);
    }
    
    .status-warning { 
      background: var(--warning-orange-100);
      color: var(--warning-orange);
      border: 1px solid var(--warning-orange-200);
    }
    
    /* 動畫增強 */
    .template-button:active {
      transform: translateY(0) scale(0.95);
    }
    
    .step-indicator:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }
    
    /* 特殊狀態 */
    .form-input:focus {
      animation: focusPulse 0.3s ease;
    }
    
    @keyframes focusPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
  </style>
</body>
</html>