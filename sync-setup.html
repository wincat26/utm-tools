<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTM Manager - Google Sheet åŒæ­¥è¨­å®š</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="shared/styles.css">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="nav-container">
    <div class="text-xl font-bold">UTM Manager</div>
    <div class="nav-tabs">
      <a href="index.html" class="nav-tab">ğŸ”— ç”¢ç”Ÿå™¨</a>
      <a href="history.html" class="nav-tab">ğŸ“‹ æˆ‘çš„é€£çµ</a>
      <a href="templates.html" class="nav-tab">ğŸ“ å¸¸ç”¨ç¯„æœ¬</a>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="main-container">
    <div class="page-card max-w-3xl mx-auto">
      <h1 class="text-2xl font-bold mb-6 text-center">ğŸ”„ Google Sheet åŒæ­¥è¨­å®š</h1>
      
      <!-- åŠŸèƒ½ä»‹ç´¹ -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-4">åŒæ­¥åŠŸèƒ½èªªæ˜</h2>
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-blue-800">å°‡ä½ çš„ UTM é€£çµè¨˜éŒ„è‡ªå‹•åŒæ­¥åˆ° Google Sheetï¼Œæ–¹ä¾¿åœ˜éšŠå…±äº«å’Œåˆ†ææ•¸æ“šã€‚</p>
        </div>
      </div>

      <!-- è¨­å®šæ­¥é©Ÿ -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-4">è¨­å®šæ­¥é©Ÿ</h2>
        
        <!-- æ­¥é©Ÿ1 -->
        <div class="mb-6 border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3 mb-3">
            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">1</span>
            <h3 class="font-medium text-lg">å»ºç«‹ Google Sheet</h3>
          </div>
          <div class="ml-9 space-y-2 text-sm text-gray-600">
            <p>â€¢ å»ºç«‹ä¸€å€‹æ–°çš„ Google Sheet</p>
            <p>â€¢ åœ¨ç¬¬ä¸€åˆ—è¨­å®šä»¥ä¸‹æ¨™é¡Œï¼ˆé †åºå¯èª¿æ•´ï¼‰ï¼š</p>
            <div class="bg-gray-100 p-3 rounded font-mono text-xs">
              timestamp | websiteurl | utm_source | utm_medium | utm_campaign | utm_term | utm_content | finalurl
            </div>
          </div>
        </div>

        <!-- æ­¥é©Ÿ2 -->
        <div class="mb-6 border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3 mb-3">
            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">2</span>
            <h3 class="font-medium text-lg">å»ºç«‹ Google Apps Script</h3>
          </div>
          <div class="ml-9 space-y-2 text-sm text-gray-600">
            <p>â€¢ å‰å¾€ <a href="https://script.google.com" target="_blank" class="text-blue-600 hover:underline">script.google.com</a></p>
            <p>â€¢ é»æ“Šã€Œæ–°å¢å°ˆæ¡ˆã€</p>
            <p>â€¢ å°‡ä»¥ä¸‹ç¨‹å¼ç¢¼è²¼å…¥ç·¨è¼¯å™¨ï¼š</p>
            <div class="bg-gray-900 text-green-400 p-3 rounded text-xs overflow-x-auto">
              <pre>function doGet(e) {
  return ContentService.createTextOutput("Hello, I am a UTM link builder.");
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const spreadsheetId = 'YOUR_SPREADSHEET_ID'; // æ›¿æ›æˆä½ çš„ Sheet ID
    const sheetName = 'å·¥ä½œè¡¨1'; // æ›¿æ›æˆä½ çš„å·¥ä½œè¡¨åç¨±
    
    const sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName(sheetName);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    let rowData = headers.map(header => {
      const key = header.toLowerCase().replace(/\s\(.*\)/, '').replace(/_/g, '').replace(/\s/g, '');
      const dataKey = key.includes('utm') ? `utm_${key.replace('utm','')}` : key;
      return data[dataKey] || '';
    });
    
    sheet.appendRow(rowData);
    return ContentService.createTextOutput(JSON.stringify({ 'result': 'success' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ 'result': 'error', 'message': error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
            </div>
          </div>
        </div>

        <!-- æ­¥é©Ÿ3 -->
        <div class="mb-6 border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3 mb-3">
            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">3</span>
            <h3 class="font-medium text-lg">ä¿®æ”¹ç¨‹å¼ç¢¼è¨­å®š</h3>
          </div>
          <div class="ml-9 space-y-2 text-sm text-gray-600">
            <p>â€¢ å°‡ <code class="bg-gray-100 px-1 rounded">YOUR_SPREADSHEET_ID</code> æ›¿æ›æˆä½ çš„ Google Sheet ID</p>
            <p>â€¢ Sheet ID å¯å¾ç¶²å€ä¸­å–å¾—ï¼š<code class="bg-gray-100 px-1 rounded text-xs">https://docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</code></p>
            <p>â€¢ ç¢ºèª <code class="bg-gray-100 px-1 rounded">sheetName</code> èˆ‡ä½ çš„å·¥ä½œè¡¨åç¨±ä¸€è‡´</p>
          </div>
        </div>

        <!-- æ­¥é©Ÿ4 -->
        <div class="mb-6 border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3 mb-3">
            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">4</span>
            <h3 class="font-medium text-lg">éƒ¨ç½²ç‚º Web App</h3>
          </div>
          <div class="ml-9 space-y-2 text-sm text-gray-600">
            <p>â€¢ é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€</p>
            <p>â€¢ é¡å‹é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</p>
            <p>â€¢ åŸ·è¡Œèº«åˆ†ï¼šé¸æ“‡ä½ çš„å¸³è™Ÿ</p>
            <p>â€¢ å­˜å–æ¬Šï¼šã€Œä»»ä½•äººã€</p>
            <p>â€¢ é»æ“Šã€Œéƒ¨ç½²ã€ä¸¦è¤‡è£½ Web App URL</p>
          </div>
        </div>

        <!-- æ­¥é©Ÿ5 -->
        <div class="mb-6 border border-gray-200 rounded-lg p-4">
          <div class="flex items-start gap-3 mb-3">
            <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">5</span>
            <h3 class="font-medium text-lg">åœ¨ UTM Manager ä¸­è¨­å®š</h3>
          </div>
          <div class="ml-9 space-y-2 text-sm text-gray-600">
            <p>â€¢ å‰å¾€ã€Œæˆ‘çš„é€£çµã€é é¢</p>
            <p>â€¢ é»æ“Šã€Œâš™ï¸ åŒæ­¥è¨­å®šã€</p>
            <p>â€¢ è²¼ä¸Šä½ çš„ Web App URL</p>
            <p>â€¢ ç³»çµ±æœƒè‡ªå‹•æ¸¬è©¦é€£ç·š</p>
          </div>
        </div>
      </div>

      <!-- æ¸¬è©¦å€åŸŸ -->
      <div class="mb-8 p-4 bg-green-50 border border-green-200 rounded-lg">
        <h3 class="font-medium text-green-800 mb-3">ğŸ§ª æ¸¬è©¦åŒæ­¥åŠŸèƒ½</h3>
        <div class="space-y-3">
          <input type="url" id="testApiUrl" placeholder="è²¼ä¸Šä½ çš„ Google Apps Script Web App URL" class="form-input">
          <button id="testSync" class="btn-primary w-full">æ¸¬è©¦é€£ç·š</button>
        </div>
      </div>

      <!-- å¸¸è¦‹å•é¡Œ -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-4">å¸¸è¦‹å•é¡Œ</h2>
        <div class="space-y-4">
          <div class="border border-gray-200 rounded-lg p-4">
            <h4 class="font-medium mb-2">â“ åŒæ­¥å¤±æ•—æ€éº¼è¾¦ï¼Ÿ</h4>
            <ul class="text-sm text-gray-600 space-y-1">
              <li>â€¢ ç¢ºèª Google Sheet çš„æ¨™é¡Œåˆ—æ ¼å¼æ­£ç¢º</li>
              <li>â€¢ æª¢æŸ¥ Apps Script ä¸­çš„ spreadsheetId å’Œ sheetName</li>
              <li>â€¢ ç¢ºèª Web App çš„å­˜å–æ¬Šè¨­å®šç‚ºã€Œä»»ä½•äººã€</li>
            </ul>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <h4 class="font-medium mb-2">ğŸ”’ è³‡æ–™å®‰å…¨æ€§å¦‚ä½•ï¼Ÿ</h4>
            <ul class="text-sm text-gray-600 space-y-1">
              <li>â€¢ åªæœ‰ä½ è¨­å®šçš„ Google Sheet æœƒæ¥æ”¶è³‡æ–™</li>
              <li>â€¢ Web App URL å„²å­˜åœ¨ä½ çš„ç€è¦½å™¨æœ¬åœ°</li>
              <li>â€¢ å¯éš¨æ™‚æ¸…é™¤è¨­å®šåœç”¨åŒæ­¥åŠŸèƒ½</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="text-center">
        <a href="history.html" class="text-blue-600 hover:underline">â† å›åˆ°æˆ‘çš„é€£çµ</a>
      </div>

      <div id="statusMessage" class="text-center text-sm mt-4"></div>
    </div>
  </div>

  <script src="shared/utils.js"></script>
  <script src="shared/sync-api.js"></script>
  <script>
    document.getElementById('testSync').addEventListener('click', async () => {
      const apiUrl = document.getElementById('testApiUrl').value.trim();
      
      if (!apiUrl) {
        showStatus('è«‹è¼¸å…¥ Web App URL', 'error');
        return;
      }
      
      // æš«æ™‚è¨­å®šURLé€²è¡Œæ¸¬è©¦
      const originalUrl = syncManager.apiUrl;
      syncManager.setApiUrl(apiUrl);
      
      try {
        showStatus('æ­£åœ¨æ¸¬è©¦é€£ç·š...', 'info');
        await syncManager.testConnection();
        showStatus('âœ… é€£ç·šæ¸¬è©¦æˆåŠŸï¼', 'success');
      } catch (error) {
        showStatus(`âŒ é€£ç·šæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        // æ¢å¾©åŸè¨­å®š
        syncManager.setApiUrl(originalUrl);
      }
    });
  </script>

  <style>
    .status-success { @apply text-green-600; }
    .status-error { @apply text-red-600; }
    .status-info { @apply text-blue-600; }
    code { @apply bg-gray-100 px-1 rounded text-sm; }
  </style>
</body>
</html>