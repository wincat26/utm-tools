<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTM Manager - 常用範本</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="shared/styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <!-- 導航列 -->
  <nav class="bg-white shadow-sm border-b border-gray-100 px-6 py-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-link text-white text-sm"></i>
        </div>
        <h1 class="text-xl font-semibold text-gray-900">UTM Manager</h1>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="nav-tab-modern">
          <i class="fas fa-magic"></i>
          <span>產生器</span>
        </a>
        <a href="history.html" class="nav-tab-modern">
          <i class="fas fa-history"></i>
          <span>我的連結</span>
        </a>
        <a href="templates.html" class="nav-tab-modern nav-tab-active">
          <i class="fas fa-bookmark"></i>
          <span>常用範本</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- 主要內容 -->
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-bookmark text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">常用範本</h1>
          <p class="text-gray-600">快速套用預設和個人化範本</p>
        </div>
      
        <!-- 系統預設範本 -->
        <div class="mb-10">
          <div class="flex items-center gap-2 mb-6">
            <i class="fas fa-layer-group text-blue-600"></i>
            <h2 class="text-2xl font-semibold text-gray-900">系統預設範本</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="systemTemplates">
            <!-- 系統範本將在這裡動態生成 -->
          </div>
        </div>

        <!-- 個人範本 -->
        <div class="mb-10">
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
              <i class="fas fa-star text-yellow-500"></i>
              <h2 class="text-2xl font-semibold text-gray-900">我的收藏範本</h2>
            </div>
            <button id="addTemplate" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-medium hover:from-purple-600 hover:to-purple-700 transition-all flex items-center gap-2">
              <i class="fas fa-plus"></i>
              新增範本
            </button>
          </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="userTemplates">
          <!-- 用戶範本將在這裡動態生成 -->
        </div>
          <div id="noUserTemplates" class="text-center py-12 text-gray-500 hidden">
            <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-bookmark text-gray-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">還沒有收藏的範本</h3>
            <p class="text-gray-600 mb-4">點擊上方「新增範本」來建立你的第一個範本</p>
          </div>
        </div>

        <div id="statusMessage" class="text-center text-sm"></div>
      </div>
    </div>
  </div>

  <!-- 範本編輯彈窗 -->
  <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">新增範本</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">範本名稱</label>
          <input type="text" id="templateName" placeholder="例如：Facebook 品牌活動" class="form-input">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">utm_source</label>
            <input type="text" id="templateSource" placeholder="facebook" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">utm_medium</label>
            <input type="text" id="templateMedium" placeholder="paid_social" class="form-input">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">utm_campaign（可選）</label>
          <input type="text" id="templateCampaign" placeholder="預設活動名稱" class="form-input">
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button id="saveTemplate" class="btn-primary flex-1">儲存</button>
        <button id="deleteTemplate" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden">刪除</button>
        <button id="cancelTemplate" class="btn-secondary flex-1">取消</button>
      </div>
    </div>
  </div>

  <script src="shared/utils.js"></script>
  <script>
    // 系統預設範本
    const systemTemplates = [
      {
        name: 'Google Ads',
        source: 'google',
        medium: 'cpc',
        description: '適用於 Google 搜尋廣告'
      },
      {
        name: 'Facebook Ads',
        source: 'facebook',
        medium: 'paid_social',
        description: '適用於 Facebook 付費廣告'
      },
      {
        name: 'Instagram Ads',
        source: 'instagram',
        medium: 'paid_social',
        description: '適用於 Instagram 付費廣告'
      },
      {
        name: 'TikTok Ads',
        source: 'tiktok',
        medium: 'paid_social',
        description: '適用於 TikTok 廣告投放'
      },
      {
        name: 'EDM Newsletter',
        source: 'newsletter',
        medium: 'email',
        description: '適用於電子報和 EDM'
      },
      {
        name: 'LINE 官方帳號',
        source: 'line_oa',
        medium: 'im',
        description: '適用於 LINE 官方帳號推播'
      }
    ];

    // DOM 元素
    const elements = {
      systemTemplates: document.getElementById('systemTemplates'),
      userTemplates: document.getElementById('userTemplates'),
      noUserTemplates: document.getElementById('noUserTemplates'),
      addTemplate: document.getElementById('addTemplate'),
      templateModal: document.getElementById('templateModal'),
      templateName: document.getElementById('templateName'),
      templateSource: document.getElementById('templateSource'),
      templateMedium: document.getElementById('templateMedium'),
      templateCampaign: document.getElementById('templateCampaign'),
      saveTemplate: document.getElementById('saveTemplate'),
      cancelTemplate: document.getElementById('cancelTemplate')
    };

    // 渲染系統範本
    function renderSystemTemplates() {
      elements.systemTemplates.innerHTML = systemTemplates.map((template, index) => `
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 rounded-2xl p-6 hover:shadow-md transition-all">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-semibold text-gray-900 text-lg">${template.name}</h3>
            <div class="flex gap-2">
              <button onclick="editSystemTemplate(${index})" class="bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-lg text-xs font-medium hover:bg-blue-50 transition-all flex items-center gap-1">
                <i class="fas fa-edit"></i>
                編輯
              </button>
              <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-xs font-medium">系統</span>
            </div>
          </div>
          <div class="space-y-2 mb-4">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <i class="fas fa-tag text-green-500"></i>
              <span class="font-medium">Source:</span> ${template.source}
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <i class="fas fa-bullhorn text-orange-500"></i>
              <span class="font-medium">Medium:</span> ${template.medium}
            </div>
          </div>
          <p class="text-sm text-gray-600 mb-4">${template.description}</p>
          <button onclick="useTemplate('${template.source}', '${template.medium}')" 
                  class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-4 rounded-xl font-medium hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-rocket"></i>
            使用範本
          </button>
        </div>
      `).join('');
    }

    // 渲染用戶範本
    function renderUserTemplates() {
      const userTemplates = Storage.get('user_templates') || [];
      
      if (userTemplates.length === 0) {
        elements.userTemplates.innerHTML = '';
        elements.noUserTemplates.classList.remove('hidden');
        return;
      }
      
      elements.noUserTemplates.classList.add('hidden');
      elements.userTemplates.innerHTML = userTemplates.map((template, index) => `
        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border border-yellow-100 rounded-2xl p-6 hover:shadow-md transition-all">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-semibold text-gray-900 text-lg">${template.name}</h3>
            <div class="flex gap-2">
              <button onclick="editUserTemplate(${index})" 
                      class="bg-white border border-yellow-200 text-yellow-700 px-3 py-1 rounded-lg text-xs font-medium hover:bg-yellow-50 transition-all flex items-center gap-1">
                <i class="fas fa-edit"></i>
                編輯
              </button>
              <button onclick="deleteUserTemplate(${index})" 
                      class="bg-white border border-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-medium hover:bg-red-50 transition-all flex items-center gap-1">
                <i class="fas fa-trash"></i>
                刪除
              </button>
            </div>
          </div>
          <div class="space-y-2 mb-4">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <i class="fas fa-tag text-green-500"></i>
              <span class="font-medium">Source:</span> ${template.source}
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <i class="fas fa-bullhorn text-orange-500"></i>
              <span class="font-medium">Medium:</span> ${template.medium}
            </div>
            ${template.campaign ? `
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="fas fa-rocket text-purple-500"></i>
                <span class="font-medium">Campaign:</span> ${template.campaign}
              </div>
            ` : ''}
          </div>
          <button onclick="useUserTemplate(${index})" 
                  class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-3 px-4 rounded-xl font-medium hover:from-yellow-600 hover:to-orange-600 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-star"></i>
            使用範本
          </button>
        </div>
      `).join('');
    }

    // 使用系統範本
    function useTemplate(source, medium) {
      const params = new URLSearchParams({
        source: source,
        medium: medium
      });
      window.location.href = `index.html?${params.toString()}`;
    }

    // 使用用戶範本
    function useUserTemplate(index) {
      const userTemplates = Storage.get('user_templates') || [];
      const template = userTemplates[index];
      if (!template) return;
      
      const params = new URLSearchParams({
        source: template.source,
        medium: template.medium
      });
      if (template.campaign) {
        params.set('campaign', template.campaign);
      }
      window.location.href = `index.html?${params.toString()}`;
    }

    // 刪除用戶範本
    function deleteUserTemplate(index) {
      if (!confirm('確定要刪除這個範本嗎？')) return;
      
      const userTemplates = Storage.get('user_templates') || [];
      userTemplates.splice(index, 1);
      Storage.set('user_templates', userTemplates);
      renderUserTemplates();
      showStatus('範本已刪除', 'success');
    }

    let editingIndex = -1; // 編輯模式的索引

    let isSystemTemplate = false; // 記錄是否為系統範本
    
    // 顯示範本彈窗（新增或編輯）
    function showTemplateModal(isEdit = false, templateData = null, index = -1, fromSystem = false) {
      editingIndex = index;
      isSystemTemplate = fromSystem;
      
      const deleteBtn = document.getElementById('deleteTemplate');
      
      if (isEdit && templateData) {
        if (fromSystem) {
          document.getElementById('modalTitle').textContent = '編輯系統範本（將儲存為個人範本）';
          deleteBtn.classList.add('hidden'); // 系統範本不能刪除
        } else {
          document.getElementById('modalTitle').textContent = '編輯範本';
          deleteBtn.classList.remove('hidden'); // 個人範本可以刪除
        }
        elements.templateName.value = templateData.name;
        elements.templateSource.value = templateData.source;
        elements.templateMedium.value = templateData.medium;
        elements.templateCampaign.value = templateData.campaign || '';
      } else {
        document.getElementById('modalTitle').textContent = '新增範本';
        deleteBtn.classList.add('hidden'); // 新增模式不顯示刪除
        elements.templateName.value = '';
        elements.templateSource.value = '';
        elements.templateMedium.value = '';
        elements.templateCampaign.value = '';
      }
      
      elements.templateModal.classList.remove('hidden');
      elements.templateModal.classList.add('flex');
      elements.templateName.focus();
    }

    // 隱藏範本彈窗
    function hideTemplateModal() {
      elements.templateModal.classList.add('hidden');
      elements.templateModal.classList.remove('flex');
      editingIndex = -1;
    }
    
    // 新增範本
    function showAddTemplate() {
      showTemplateModal(false);
    }
    
    // 刪除當前編輯的範本
    function deleteCurrentTemplate() {
      if (editingIndex >= 0 && !isSystemTemplate) {
        const userTemplates = Storage.get('user_templates') || [];
        const templateName = userTemplates[editingIndex]?.name || '範本';
        
        if (confirm(`確定要刪除「${templateName}」嗎？`)) {
          userTemplates.splice(editingIndex, 1);
          Storage.set('user_templates', userTemplates);
          hideTemplateModal();
          renderUserTemplates();
          showStatus('範本已刪除', 'success');
        }
      }
    }

    // 儲存範本（新增或編輯）
    function saveTemplate() {
      const name = elements.templateName.value.trim();
      const source = elements.templateSource.value.trim();
      const medium = elements.templateMedium.value.trim();
      const campaign = elements.templateCampaign.value.trim();
      
      if (!name || !source || !medium) {
        showStatus('請填寫範本名稱、source 和 medium', 'error');
        return;
      }
      
      const userTemplates = Storage.get('user_templates') || [];
      const templateData = { name, source, medium };
      if (campaign) templateData.campaign = campaign;
      
      if (isSystemTemplate) {
        // 系統範本編輯：儲存為新的個人範本
        if (userTemplates.length >= 10) {
          showStatus('最多只能儲存 10 個個人範本', 'error');
          return;
        }
        userTemplates.push(templateData);
        showStatus('系統範本已儲存為個人範本！', 'success');
      } else if (editingIndex >= 0) {
        // 編輯個人範本
        userTemplates[editingIndex] = templateData;
        showStatus('範本已更新', 'success');
      } else {
        // 新增個人範本
        if (userTemplates.length >= 10) {
          showStatus('最多只能儲存 10 個個人範本', 'error');
          return;
        }
        userTemplates.push(templateData);
        showStatus('範本已儲存', 'success');
      }
      
      Storage.set('user_templates', userTemplates);
      hideTemplateModal();
      renderUserTemplates();
    }
    
    // 編輯系統範本（儲存為個人範本）
    function editSystemTemplate(index) {
      const template = systemTemplates[index];
      if (!template) return;
      
      // 使用系統範本資料作為預設值
      const templateData = {
        name: template.name,
        source: template.source,
        medium: template.medium,
        campaign: '' // 系統範本通常沒有預設 campaign
      };
      
      showTemplateModal(true, templateData, -1, true); // 最後一個參數表示是系統範本
    }
    
    // 編輯用戶範本
    function editUserTemplate(index) {
      const userTemplates = Storage.get('user_templates') || [];
      const template = userTemplates[index];
      if (!template) return;
      
      showTemplateModal(true, template, index, false);
    }

    // 事件綁定
    document.addEventListener('DOMContentLoaded', () => {
      // 渲染範本
      renderSystemTemplates();
      renderUserTemplates();
      
      // 按鈕事件
      elements.addTemplate.addEventListener('click', showAddTemplate);
      elements.cancelTemplate.addEventListener('click', hideTemplateModal);
      elements.saveTemplate.addEventListener('click', saveTemplate);
      document.getElementById('deleteTemplate').addEventListener('click', deleteCurrentTemplate);
      
      // 彈窗背景點擊關閉
      elements.templateModal.addEventListener('click', (e) => {
        if (e.target === elements.templateModal) {
          hideTemplateModal();
        }
      });
      
      // Enter 鍵儲存
      elements.templateModal.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveTemplate();
        }
      });
    });

    // 全域函數
    window.useTemplate = useTemplate;
    window.useUserTemplate = useUserTemplate;
    window.editSystemTemplate = editSystemTemplate;
    window.editUserTemplate = editUserTemplate;
    window.deleteUserTemplate = deleteUserTemplate;
  </script>

  <style>
    .nav-tab-modern {
      @apply flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all no-underline;
      @apply text-gray-600 hover:text-gray-900 hover:bg-gray-100;
    }
    
    .nav-tab-active {
      @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm;
    }
    
    .nav-tab-active:hover {
      @apply from-blue-600 to-blue-700 text-white;
    }
    
    .status-success { @apply text-green-600; }
    .status-error { @apply text-red-600; }
    .status-info { @apply text-blue-600; }
  </style>
</body>
</html>