<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UTM Manager - å¸¸ç”¨ç¯„æœ¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="shared/styles.css">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="nav-container">
    <div class="text-xl font-bold">UTM Manager</div>
    <div class="nav-tabs">
      <a href="index.html" class="nav-tab">ğŸ”— ç”¢ç”Ÿå™¨</a>
      <a href="history.html" class="nav-tab">ğŸ“‹ æˆ‘çš„é€£çµ</a>
      <a href="templates.html" class="nav-tab">ğŸ“ å¸¸ç”¨ç¯„æœ¬</a>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="main-container">
    <div class="page-card">
      <h1 class="text-2xl font-bold mb-6">å¸¸ç”¨ç¯„æœ¬</h1>
      
      <!-- ç³»çµ±é è¨­ç¯„æœ¬ -->
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-4">ğŸ“‹ ç³»çµ±é è¨­ç¯„æœ¬</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="systemTemplates">
          <!-- ç³»çµ±ç¯„æœ¬å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- å€‹äººæ”¶è—ç¯„æœ¬ -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">â­ æˆ‘çš„æ”¶è—ç¯„æœ¬</h2>
          <button id="addTemplate" class="btn-primary text-sm">+ æ–°å¢ç¯„æœ¬</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="userTemplates">
          <!-- ç”¨æˆ¶ç¯„æœ¬å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div id="noUserTemplates" class="text-center py-8 text-gray-500 hidden">
          <div class="text-3xl mb-2">ğŸ“</div>
          <p>é‚„æ²’æœ‰æ”¶è—çš„ç¯„æœ¬</p>
          <p class="text-sm mt-1">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢ç¯„æœ¬ã€ä¾†å»ºç«‹ä½ çš„ç¬¬ä¸€å€‹ç¯„æœ¬</p>
        </div>
      </div>

      <div id="statusMessage" class="text-center text-sm"></div>
    </div>
  </div>

  <!-- ç¯„æœ¬ç·¨è¼¯å½ˆçª— -->
  <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">æ–°å¢ç¯„æœ¬</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">ç¯„æœ¬åç¨±</label>
          <input type="text" id="templateName" placeholder="ä¾‹å¦‚ï¼šFacebook å“ç‰Œæ´»å‹•" class="form-input">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">utm_source</label>
            <input type="text" id="templateSource" placeholder="facebook" class="form-input">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">utm_medium</label>
            <input type="text" id="templateMedium" placeholder="paid_social" class="form-input">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">utm_campaignï¼ˆå¯é¸ï¼‰</label>
          <input type="text" id="templateCampaign" placeholder="é è¨­æ´»å‹•åç¨±" class="form-input">
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button id="saveTemplate" class="btn-primary flex-1">å„²å­˜</button>
        <button id="deleteTemplate" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden">åˆªé™¤</button>
        <button id="cancelTemplate" class="btn-secondary flex-1">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="shared/utils.js"></script>
  <script>
    // ç³»çµ±é è¨­ç¯„æœ¬
    const systemTemplates = [
      {
        name: 'Google Ads',
        source: 'google',
        medium: 'cpc',
        description: 'é©ç”¨æ–¼ Google æœå°‹å»£å‘Š'
      },
      {
        name: 'Facebook Ads',
        source: 'facebook',
        medium: 'paid_social',
        description: 'é©ç”¨æ–¼ Facebook ä»˜è²»å»£å‘Š'
      },
      {
        name: 'Instagram Ads',
        source: 'instagram',
        medium: 'paid_social',
        description: 'é©ç”¨æ–¼ Instagram ä»˜è²»å»£å‘Š'
      },
      {
        name: 'TikTok Ads',
        source: 'tiktok',
        medium: 'paid_social',
        description: 'é©ç”¨æ–¼ TikTok å»£å‘ŠæŠ•æ”¾'
      },
      {
        name: 'EDM Newsletter',
        source: 'newsletter',
        medium: 'email',
        description: 'é©ç”¨æ–¼é›»å­å ±å’Œ EDM'
      },
      {
        name: 'LINE å®˜æ–¹å¸³è™Ÿ',
        source: 'line_oa',
        medium: 'im',
        description: 'é©ç”¨æ–¼ LINE å®˜æ–¹å¸³è™Ÿæ¨æ’­'
      }
    ];

    // DOM å…ƒç´ 
    const elements = {
      systemTemplates: document.getElementById('systemTemplates'),
      userTemplates: document.getElementById('userTemplates'),
      noUserTemplates: document.getElementById('noUserTemplates'),
      addTemplate: document.getElementById('addTemplate'),
      templateModal: document.getElementById('templateModal'),
      templateName: document.getElementById('templateName'),
      templateSource: document.getElementById('templateSource'),
      templateMedium: document.getElementById('templateMedium'),
      templateCampaign: document.getElementById('templateCampaign'),
      saveTemplate: document.getElementById('saveTemplate'),
      cancelTemplate: document.getElementById('cancelTemplate')
    };

    // æ¸²æŸ“ç³»çµ±ç¯„æœ¬
    function renderSystemTemplates() {
      elements.systemTemplates.innerHTML = systemTemplates.map((template, index) => `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-medium text-blue-900">${template.name}</h3>
            <div class="flex gap-1">
              <button onclick="editSystemTemplate(${index})" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">
                âœï¸ ç·¨è¼¯
              </button>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">ç³»çµ±</span>
            </div>
          </div>
          <div class="text-sm text-blue-700 mb-3">
            <div>Source: ${template.source}</div>
            <div>Medium: ${template.medium}</div>
          </div>
          <p class="text-xs text-blue-600 mb-3">${template.description}</p>
          <button onclick="useTemplate('${template.source}', '${template.medium}')" 
                  class="w-full bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition-colors">
            ä½¿ç”¨ç¯„æœ¬
          </button>
        </div>
      `).join('');
    }

    // æ¸²æŸ“ç”¨æˆ¶ç¯„æœ¬
    function renderUserTemplates() {
      const userTemplates = Storage.get('user_templates') || [];
      
      if (userTemplates.length === 0) {
        elements.userTemplates.innerHTML = '';
        elements.noUserTemplates.classList.remove('hidden');
        return;
      }
      
      elements.noUserTemplates.classList.add('hidden');
      elements.userTemplates.innerHTML = userTemplates.map((template, index) => `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-medium text-green-900">${template.name}</h3>
            <div class="flex gap-1">
              <button onclick="editUserTemplate(${index})" 
                      class="text-blue-500 hover:text-blue-700 text-sm">
                âœï¸
              </button>
              <button onclick="deleteUserTemplate(${index})" 
                      class="text-red-500 hover:text-red-700 text-sm">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
          <div class="text-sm text-green-700 mb-3">
            <div>Source: ${template.source}</div>
            <div>Medium: ${template.medium}</div>
            ${template.campaign ? `<div>Campaign: ${template.campaign}</div>` : ''}
          </div>
          <button onclick="useUserTemplate(${index})" 
                  class="w-full bg-green-600 text-white py-2 px-3 rounded text-sm hover:bg-green-700 transition-colors">
            ä½¿ç”¨ç¯„æœ¬
          </button>
        </div>
      `).join('');
    }

    // ä½¿ç”¨ç³»çµ±ç¯„æœ¬
    function useTemplate(source, medium) {
      const params = new URLSearchParams({
        source: source,
        medium: medium
      });
      window.location.href = `index.html?${params.toString()}`;
    }

    // ä½¿ç”¨ç”¨æˆ¶ç¯„æœ¬
    function useUserTemplate(index) {
      const userTemplates = Storage.get('user_templates') || [];
      const template = userTemplates[index];
      if (!template) return;
      
      const params = new URLSearchParams({
        source: template.source,
        medium: template.medium
      });
      if (template.campaign) {
        params.set('campaign', template.campaign);
      }
      window.location.href = `index.html?${params.toString()}`;
    }

    // åˆªé™¤ç”¨æˆ¶ç¯„æœ¬
    function deleteUserTemplate(index) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯„æœ¬å—ï¼Ÿ')) return;
      
      const userTemplates = Storage.get('user_templates') || [];
      userTemplates.splice(index, 1);
      Storage.set('user_templates', userTemplates);
      renderUserTemplates();
      showStatus('ç¯„æœ¬å·²åˆªé™¤', 'success');
    }

    let editingIndex = -1; // ç·¨è¼¯æ¨¡å¼çš„ç´¢å¼•

    let isSystemTemplate = false; // è¨˜éŒ„æ˜¯å¦ç‚ºç³»çµ±ç¯„æœ¬
    
    // é¡¯ç¤ºç¯„æœ¬å½ˆçª—ï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
    function showTemplateModal(isEdit = false, templateData = null, index = -1, fromSystem = false) {
      editingIndex = index;
      isSystemTemplate = fromSystem;
      
      const deleteBtn = document.getElementById('deleteTemplate');
      
      if (isEdit && templateData) {
        if (fromSystem) {
          document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç³»çµ±ç¯„æœ¬ï¼ˆå°‡å„²å­˜ç‚ºå€‹äººç¯„æœ¬ï¼‰';
          deleteBtn.classList.add('hidden'); // ç³»çµ±ç¯„æœ¬ä¸èƒ½åˆªé™¤
        } else {
          document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¯„æœ¬';
          deleteBtn.classList.remove('hidden'); // å€‹äººç¯„æœ¬å¯ä»¥åˆªé™¤
        }
        elements.templateName.value = templateData.name;
        elements.templateSource.value = templateData.source;
        elements.templateMedium.value = templateData.medium;
        elements.templateCampaign.value = templateData.campaign || '';
      } else {
        document.getElementById('modalTitle').textContent = 'æ–°å¢ç¯„æœ¬';
        deleteBtn.classList.add('hidden'); // æ–°å¢æ¨¡å¼ä¸é¡¯ç¤ºåˆªé™¤
        elements.templateName.value = '';
        elements.templateSource.value = '';
        elements.templateMedium.value = '';
        elements.templateCampaign.value = '';
      }
      
      elements.templateModal.classList.remove('hidden');
      elements.templateModal.classList.add('flex');
      elements.templateName.focus();
    }

    // éš±è—ç¯„æœ¬å½ˆçª—
    function hideTemplateModal() {
      elements.templateModal.classList.add('hidden');
      elements.templateModal.classList.remove('flex');
      editingIndex = -1;
    }
    
    // æ–°å¢ç¯„æœ¬
    function showAddTemplate() {
      showTemplateModal(false);
    }
    
    // åˆªé™¤ç•¶å‰ç·¨è¼¯çš„ç¯„æœ¬
    function deleteCurrentTemplate() {
      if (editingIndex >= 0 && !isSystemTemplate) {
        const userTemplates = Storage.get('user_templates') || [];
        const templateName = userTemplates[editingIndex]?.name || 'ç¯„æœ¬';
        
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${templateName}ã€å—ï¼Ÿ`)) {
          userTemplates.splice(editingIndex, 1);
          Storage.set('user_templates', userTemplates);
          hideTemplateModal();
          renderUserTemplates();
          showStatus('ç¯„æœ¬å·²åˆªé™¤', 'success');
        }
      }
    }

    // å„²å­˜ç¯„æœ¬ï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
    function saveTemplate() {
      const name = elements.templateName.value.trim();
      const source = elements.templateSource.value.trim();
      const medium = elements.templateMedium.value.trim();
      const campaign = elements.templateCampaign.value.trim();
      
      if (!name || !source || !medium) {
        showStatus('è«‹å¡«å¯«ç¯„æœ¬åç¨±ã€source å’Œ medium', 'error');
        return;
      }
      
      const userTemplates = Storage.get('user_templates') || [];
      const templateData = { name, source, medium };
      if (campaign) templateData.campaign = campaign;
      
      if (isSystemTemplate) {
        // ç³»çµ±ç¯„æœ¬ç·¨è¼¯ï¼šå„²å­˜ç‚ºæ–°çš„å€‹äººç¯„æœ¬
        if (userTemplates.length >= 10) {
          showStatus('æœ€å¤šåªèƒ½å„²å­˜ 10 å€‹å€‹äººç¯„æœ¬', 'error');
          return;
        }
        userTemplates.push(templateData);
        showStatus('ç³»çµ±ç¯„æœ¬å·²å„²å­˜ç‚ºå€‹äººç¯„æœ¬ï¼', 'success');
      } else if (editingIndex >= 0) {
        // ç·¨è¼¯å€‹äººç¯„æœ¬
        userTemplates[editingIndex] = templateData;
        showStatus('ç¯„æœ¬å·²æ›´æ–°', 'success');
      } else {
        // æ–°å¢å€‹äººç¯„æœ¬
        if (userTemplates.length >= 10) {
          showStatus('æœ€å¤šåªèƒ½å„²å­˜ 10 å€‹å€‹äººç¯„æœ¬', 'error');
          return;
        }
        userTemplates.push(templateData);
        showStatus('ç¯„æœ¬å·²å„²å­˜', 'success');
      }
      
      Storage.set('user_templates', userTemplates);
      hideTemplateModal();
      renderUserTemplates();
    }
    
    // ç·¨è¼¯ç³»çµ±ç¯„æœ¬ï¼ˆå„²å­˜ç‚ºå€‹äººç¯„æœ¬ï¼‰
    function editSystemTemplate(index) {
      const template = systemTemplates[index];
      if (!template) return;
      
      // ä½¿ç”¨ç³»çµ±ç¯„æœ¬è³‡æ–™ä½œç‚ºé è¨­å€¼
      const templateData = {
        name: template.name,
        source: template.source,
        medium: template.medium,
        campaign: '' // ç³»çµ±ç¯„æœ¬é€šå¸¸æ²’æœ‰é è¨­ campaign
      };
      
      showTemplateModal(true, templateData, -1, true); // æœ€å¾Œä¸€å€‹åƒæ•¸è¡¨ç¤ºæ˜¯ç³»çµ±ç¯„æœ¬
    }
    
    // ç·¨è¼¯ç”¨æˆ¶ç¯„æœ¬
    function editUserTemplate(index) {
      const userTemplates = Storage.get('user_templates') || [];
      const template = userTemplates[index];
      if (!template) return;
      
      showTemplateModal(true, template, index, false);
    }

    // äº‹ä»¶ç¶å®š
    document.addEventListener('DOMContentLoaded', () => {
      // æ¸²æŸ“ç¯„æœ¬
      renderSystemTemplates();
      renderUserTemplates();
      
      // æŒ‰éˆ•äº‹ä»¶
      elements.addTemplate.addEventListener('click', showAddTemplate);
      elements.cancelTemplate.addEventListener('click', hideTemplateModal);
      elements.saveTemplate.addEventListener('click', saveTemplate);
      document.getElementById('deleteTemplate').addEventListener('click', deleteCurrentTemplate);
      
      // å½ˆçª—èƒŒæ™¯é»æ“Šé—œé–‰
      elements.templateModal.addEventListener('click', (e) => {
        if (e.target === elements.templateModal) {
          hideTemplateModal();
        }
      });
      
      // Enter éµå„²å­˜
      elements.templateModal.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveTemplate();
        }
      });
    });

    // å…¨åŸŸå‡½æ•¸
    window.useTemplate = useTemplate;
    window.useUserTemplate = useUserTemplate;
    window.editSystemTemplate = editSystemTemplate;
    window.editUserTemplate = editUserTemplate;
    window.deleteUserTemplate = deleteUserTemplate;
  </script>

  <style>
    .status-success { @apply text-green-600; }
    .status-error { @apply text-red-600; }
    .status-info { @apply text-blue-600; }
  </style>
</body>
</html>